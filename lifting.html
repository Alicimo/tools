<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tactical Barbell - Operator (6-Week Wave)</title>

  <!-- Bootstrap 5 (no React) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small-note { font-size: 0.9rem; color: #6c757d; }
    .sticky-top-lite { position: sticky; top: 0; z-index: 1020; background: white; }
    .table td, .table th { vertical-align: middle; }
    .plate-breakdown { font-size: 0.85rem; color: #495057; }
    .plate-breakdown summary { cursor: pointer; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-3">

    <!-- SETTINGS / INPUTS -->
    <div class="card shadow-sm mb-3 sticky-top-lite">
      <div class="card-header bg-white">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <h1 class="h5 mb-0">Tactical Barbell – Operator (6-Week Wave)</h1>
          <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false" aria-controls="settingsCollapse">
            Show inputs
          </button>
        </div>
      </div>
      <div id="settingsCollapse" class="collapse">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-6 col-lg-3">
              <label class="form-label">Squat 1RM (kg)</label>
              <input id="rmSquat" type="number" class="form-control" min="1" step="0.25" value="109">
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Bench 1RM (kg)</label>
              <input id="rmBench" type="number" class="form-control" min="1" step="0.25" value="82">
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Pull-up max reps</label>
              <input id="maxPullupReps" type="number" class="form-control" min="1" step="1" value="9">
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Rounding (kg)</label>
              <select id="rounding" class="form-select">
                <option value="0.5" selected>0.5 kg</option>
                <option value="1">1 kg</option>
                <option value="2.5">2.5 kg</option>
                <option value="5">5 kg</option>
                <option value="0">No rounding</option>
              </select>
            </div>
            <div class="col-6 col-lg-3">
              <label class="form-label">Bar weight (kg)</label>
              <input id="barWeight" type="number" class="form-control" min="0" step="0.5" value="20">
            </div>

            <div class="col-12">
              <label class="form-label">Available plates (pairs)</label>
              <div id="plateInputs" class="row g-2 align-items-end"></div>
              <div class="small-note mt-1">
                Counts are pairs, so a 20 kg plate means 40 kg total on the bar.
              </div>
            </div>

            <div class="col-12">
              <div class="d-flex flex-wrap gap-2 mt-2">
                <button id="btnReset" class="btn btn-outline-secondary btn-sm">Reset to defaults</button>
              </div>
              <div class="small-note mt-2">
                Pull-ups are shown as bodyweight sets/reps.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs flex-nowrap overflow-auto" id="weekTabs" role="tablist"></ul>

    <div class="tab-content border border-top-0 bg-white p-3 shadow-sm" id="weekTabContent"></div>

    <details class="mt-3">
      <summary class="fw-semibold">Program details</summary>
      <div class="small-note mt-2">
        Same main lifts each session (Mon/Wed/Fri) across six weeks. Adjust reference values above to recalc weights instantly.
        <ul class="mb-0 ps-4">
          <li><span class="mono">Week 1: 3–5×5 @70%</span></li>
          <li><span class="mono">Week 2: 3–5×5 @80%</span></li>
          <li><span class="mono">Week 3: 3–4×3 @90%</span></li>
          <li><span class="mono">Week 4: 3–5×5 @75%</span></li>
          <li><span class="mono">Week 5: 3–5×3 @85%</span></li>
          <li><span class="mono">Week 6: 3–4×1–2 @95%</span></li>
        </ul>
      </div>
    </details>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ----------------------------
    // CONFIG (easy to alter)
    // ----------------------------
    const DEFAULTS = {
      rmSquat: 109,
      rmBench: 82,
      maxPullupReps: 9,
      rounding: 0.5,
      barWeight: 20
    };

    const DEFAULT_PLATES = [
      { size: 20, pairs: 2 },
      { size: 10, pairs: 1 },
      { size: 5, pairs: 1 },
      { size: 2.5, pairs: 1 },
      { size: 1.25, pairs: 1 },
      { size: 1, pairs: 1 },
      { size: 0.5, pairs: 1 }
    ];

    // Operator 6-week wave definition
    // You can add/remove exercises here.
    const PROGRAM = [
      { key: "squat", name: "Back Squat", type: "1rm", rmInputId: "rmSquat" },
      { key: "bench", name: "Bench Press", type: "1rm", rmInputId: "rmBench" },
      { key: "pullup", name: "Pull-up (Bodyweight)", type: "bw_reps", repsInputId: "maxPullupReps" }
    ];

    // Week prescriptions (strength)
    // For 1RM lifts: percent + sets/reps.
    // For BW pull-ups: sets + repTargetPct of max reps (matched to weight % for simplicity).
    const WEEKS = [
      { id: 1, name: "Week 1", percent: 0.70, sets: "3–5", reps: "5",  pullupRepTargetPct: 0.70 },
      { id: 2, name: "Week 2", percent: 0.80, sets: "3–5", reps: "5",  pullupRepTargetPct: 0.80 },
      { id: 3, name: "Week 3", percent: 0.90, sets: "3–4", reps: "3",  pullupRepTargetPct: 0.90 },
      { id: 4, name: "Week 4", percent: 0.75, sets: "3–5", reps: "5",  pullupRepTargetPct: 0.75 },
      { id: 5, name: "Week 5", percent: 0.85, sets: "3–5", reps: "3",  pullupRepTargetPct: 0.85 },
      { id: 6, name: "Week 6", percent: 0.95, sets: "3–4", reps: "1–2", pullupRepTargetPct: 0.95 }
    ];

    // ----------------------------
    // Helpers
    // ----------------------------
    function roundToStep(value, step) {
      if (!step || step === 0) return value;
      return Math.round(value / step) * step;
    }

    function fmtKg(x) {
      // avoid trailing .0 if integer
      const rounded = Math.round(x * 10) / 10;
      return (Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1)) + " kg";
    }

    function safeInt(x, fallback) {
      const n = parseInt(x, 10);
      return Number.isFinite(n) ? n : fallback;
    }

    function safeFloat(x, fallback) {
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : fallback;
    }

    function getSettingsFromInputs() {
      const plateInputs = Array.from(document.querySelectorAll("[data-plate-size]"));
      const availablePlates = plateInputs.map(input => ({
        size: safeFloat(input.dataset.plateSize, 0),
        pairs: Math.max(0, safeInt(input.value, 0))
      })).filter(p => p.size > 0);

        return {
          rmSquat: safeFloat(document.getElementById("rmSquat").value, DEFAULTS.rmSquat),
          rmBench: safeFloat(document.getElementById("rmBench").value, DEFAULTS.rmBench),
          maxPullupReps: safeInt(document.getElementById("maxPullupReps").value, DEFAULTS.maxPullupReps),
          rounding: safeFloat(document.getElementById("rounding").value, DEFAULTS.rounding),
          barWeight: safeFloat(document.getElementById("barWeight").value, DEFAULTS.barWeight),
          availablePlates
        };
      }

    function setInputsFromSettings(s) {
      document.getElementById("rmSquat").value = s.rmSquat;
      document.getElementById("rmBench").value = s.rmBench;
      document.getElementById("maxPullupReps").value = s.maxPullupReps;
      document.getElementById("rounding").value = String(s.rounding);
      document.getElementById("barWeight").value = s.barWeight;
      DEFAULT_PLATES.forEach(plate => {
        const input = document.querySelector(`[data-plate-size="${plate.size}"]`);
        if (input) input.value = plate.pairs;
      });
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function formatPlateList(usedPlates) {
      if (!usedPlates.length) return "No plates needed per side.";
      return usedPlates.map(p => `${p.size}×${p.count}`).join(", ");
    }

    function buildPlateBreakdown(totalWeight, barWeight, availablePlates) {
      const plateTarget = Math.max(0, totalWeight - barWeight);
      const perSideTarget = plateTarget / 2;
      if (!availablePlates.length) {
        return { perSideTarget, usedPlates: [], remainder: perSideTarget };
      }

      const sorted = [...availablePlates].sort((a, b) => b.size - a.size);
      const sizes = sorted.map(plate => plate.size).filter(size => size > 0);
      const maxDecimals = sizes.reduce((acc, size) => {
        const part = String(size).split(".")[1];
        return Math.max(acc, part ? part.length : 0);
      }, 0);
      const scale = Math.pow(10, Math.min(6, maxDecimals));
      if (!Number.isFinite(scale) || scale <= 0) {
        return { perSideTarget, usedPlates: [], remainder: perSideTarget };
      }

      const sizeUnits = sizes.map(size => Math.round(size * scale));
      const gcd = (a, b) => (b === 0 ? a : gcd(b, a % b));
      const unit = sizeUnits.reduce((acc, size) => gcd(acc, size), sizeUnits[0] || 1);
      const normalizedScale = scale / unit;
      const normalizedSizes = sizeUnits.map(size => Math.round(size / unit));
      const targetUnits = Math.floor(perSideTarget * normalizedScale + 1e-6);
      const dp = Array.from({ length: targetUnits + 1 }, () => null);
      dp[0] = { plates: 0, prev: null, plateIndex: null, count: 0 };

      sorted.forEach((plate, plateIndex) => {
        const sizeUnits = normalizedSizes[plateIndex];
        const maxCount = Math.max(0, plate.pairs);
        const next = dp.slice();

        for (let w = 0; w <= targetUnits; w += 1) {
          const entry = dp[w];
          if (!entry) continue;
          for (let count = 1; count <= maxCount; count += 1) {
            const newWeight = w + count * sizeUnits;
            if (newWeight > targetUnits) break;
            const newPlates = entry.plates + count;
            const existing = next[newWeight];
            if (!existing || newPlates < existing.plates) {
              next[newWeight] = {
                plates: newPlates,
                prev: w,
                plateIndex,
                count
              };
            }
          }
        }

        for (let w = 0; w <= targetUnits; w += 1) {
          dp[w] = next[w];
        }
      });

      let bestWeight = 0;
      for (let w = targetUnits; w >= 0; w -= 1) {
        if (dp[w]) {
          bestWeight = w;
          break;
        }
      }

      const counts = new Array(sorted.length).fill(0);
      let cursor = bestWeight;
      while (cursor > 0) {
        const entry = dp[cursor];
        if (!entry || entry.prev === null || entry.plateIndex === null) break;
        counts[entry.plateIndex] += entry.count;
        cursor = entry.prev;
      }

      const usedPlates = [];
      counts.forEach((count, idx) => {
        if (count > 0) {
          usedPlates.push({ size: sorted[idx].size, count });
        }
      });

      const remainder = Math.max(0, perSideTarget - bestWeight / normalizedScale);
      return { perSideTarget, usedPlates, remainder };
    }

    function buildPlateBreakdownHtml(totalWeight, barWeight, availablePlates) {
      const breakdown = buildPlateBreakdown(totalWeight, barWeight, availablePlates);
      const remainder = breakdown.remainder;
      const remainderNote = remainder > 0.01
        ? `<div class="text-danger">Unallocated: ${fmtKg(remainder)} per side</div>`
        : "";

      return `
        <details class="plate-breakdown mt-1">
          <summary>Plate breakdown</summary>
          <div class="mt-1">
            <div>${formatPlateList(breakdown.usedPlates)}</div>
            <div class="small-note">Bar: ${fmtKg(barWeight)}. Per side (${fmtKg(breakdown.perSideTarget)} target).</div>
            ${remainderNote}
          </div>
        </details>
      `;
    }

    function buildWeekTable(week, settings) {
      const rows = PROGRAM.map(ex => {
        if (ex.type === "1rm") {
          const rm = settings[ex.rmInputId];
          const raw = rm * week.percent;
          const w = roundToStep(raw, settings.rounding);
          return `
            <tr>
              <td>${ex.name}</td>
              <td class="mono text-nowrap">${week.sets}×${week.reps}</td>
              <td class="mono text-nowrap">
                <div>${fmtKg(w)}</div>
                ${buildPlateBreakdownHtml(w, settings.barWeight, settings.availablePlates)}
              </td>
            </tr>
          `;
        }

        if (ex.type === "bw_reps") {
          const maxReps = settings[ex.repsInputId];
          const target = Math.round(maxReps * week.pullupRepTargetPct);
          return `
            <tr>
              <td>${ex.name}</td>
              <td class="mono text-nowrap">${week.sets}×${target}</td>
              <td class="mono text-nowrap">Bodyweight</td>
            </tr>
          `;
        }

        return "";
      }).join("");

      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm align-middle mb-0">
            <thead>
              <tr>
                <th style="width: 35%">Exercise</th>
                <th style="width: 20%">Sets×Reps</th>
                <th style="width: 45%">Weight</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function buildTabs() {
      const tabs = WEEKS.map((week, idx) => `
        <li class="nav-item" role="presentation">
          <button class="nav-link ${idx === 0 ? "active" : ""}" id="week${week.id}-tab" data-bs-toggle="tab" data-bs-target="#week${week.id}" type="button" role="tab">
            Week ${week.id}
          </button>
        </li>
      `).join("");

      const panels = WEEKS.map((week, idx) => `
        <div class="tab-pane fade ${idx === 0 ? "show active" : ""}" id="week${week.id}" role="tabpanel" aria-labelledby="week${week.id}-tab">
          <h2 class="h5 mb-3">${week.name} — <span class="mono">${week.sets}×${week.reps} @${Math.round(week.percent * 100)}%</span></h2>
          <div id="week${week.id}Table"></div>
        </div>
      `).join("");

      document.getElementById("weekTabs").innerHTML = tabs;
      document.getElementById("weekTabContent").innerHTML = panels;
    }

    function renderAll() {
      const settings = getSettingsFromInputs();

      // basic validation guardrails
      if (settings.rmSquat <= 0) settings.rmSquat = DEFAULTS.rmSquat;
      if (settings.rmBench <= 0) settings.rmBench = DEFAULTS.rmBench;
      if (settings.maxPullupReps <= 0) settings.maxPullupReps = DEFAULTS.maxPullupReps;
      if (settings.barWeight < 0) settings.barWeight = DEFAULTS.barWeight;

      WEEKS.forEach(week => {
        const container = document.getElementById(`week${week.id}Table`);
        if (container) container.innerHTML = buildWeekTable(week, settings);
      });
    }

    function resetDefaults() {
      setInputsFromSettings(DEFAULTS);
    }

    function renderPlateInputs() {
      const container = document.getElementById("plateInputs");
      container.innerHTML = DEFAULT_PLATES.map(plate => `
        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label mb-0">${plate.size} kg</label>
          <input type="number" min="0" step="1" class="form-control form-control-sm" data-plate-size="${plate.size}" value="${plate.pairs}">
        </div>
      `).join("");
    }

    // ----------------------------
    // Wire up events
    // ----------------------------
    ["rmSquat", "rmBench", "maxPullupReps", "rounding", "barWeight"].forEach(id => {
      document.getElementById(id).addEventListener("input", renderAll);
      document.getElementById(id).addEventListener("change", renderAll);
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      resetDefaults();
      renderAll();
    });

    // Initial load: tabs + defaults
    renderPlateInputs();
    buildTabs();
    resetDefaults();
    renderAll();

    document.querySelectorAll("[data-plate-size]").forEach(input => {
      input.addEventListener("input", renderAll);
      input.addEventListener("change", renderAll);
    });
  </script>
</body>
</html>
