<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kottingbrunn Heurigen – Karte</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body { height: 100%; }
    #map { height: 70vh; min-height: 420px; border-radius: .75rem; }
    .status-dot {
      display:inline-block; width:10px; height:10px; border-radius:50%;
      margin-right:.5rem; vertical-align:middle;
    }
    .badge-soft {
      background: rgba(0,0,0,.06);
      border: 1px solid rgba(0,0,0,.08);
      color: #111;
    }
    .small-muted { font-size:.9rem; color: #6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <div>
        <h1 class="h3 mb-1">Kottingbrunn Heurigen – Karte</h1>
        <div class="small-muted">
          Wähle ein Datum – Marker/Liste werden rot (zu) oder grün (offen).
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label for="dateInput" class="form-label mb-0 fw-semibold">Datum</label>
        <input id="dateInput" type="date" class="form-control" style="width: 165px;" />
        <button id="todayBtn" class="btn btn-outline-secondary">Heute</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold">Karte</div>
              <div class="d-flex align-items-center gap-3 small">
                <span><span class="status-dot" style="background:#198754;"></span>offen</span>
                <span><span class="status-dot" style="background:#dc3545;"></span>zu</span>
              </div>
            </div>
            <div id="map"></div>
            <div class="small-muted mt-2">
              Hinweis: Die Koordinaten werden per OpenStreetMap/Nominatim anhand der Adresse ermittelt und im Browser gecached.
              Wenn du das lokal als <span class="mono">file://</span> öffnest, kann je nach Browser das Fetching eingeschränkt sein – am besten über einen kleinen lokalen Server.
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold">Heuriger</div>
              <span id="openCount" class="badge badge-soft rounded-pill">…</span>
            </div>

            <div id="list" class="list-group"></div>

            <hr class="my-3">

            <div class="small">
              <div class="fw-semibold mb-1">Datenquelle</div>
              <div class="small-muted">
                Öffnungszeiten (Ausstecktermine) & Adressen aus dem Kottingbrunn Heurigenkalender.  [oai_citation:1‡kottingbrunn.gv.at](https://www.kottingbrunn.gv.at/Heurigenkalender_1)
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ---- Data (from https://www.kottingbrunn.gv.at/Heurigenkalender_1 calendar pages) ----
    // Dates are in DD.MM.YYYY; ranges are inclusive.
    const HEURIGER = [
      {
        id: "ednitsch",
        name: "Weinbau Ednitsch",
        address: "Hauptstraße 30, 2542 Kottingbrunn, Austria",
        website: "https://www.ednitsch.at/",
        ranges: [
          ["13.01.2026", "14.01.2026"],
          ["29.01.2026", "15.02.2026"],
          ["05.03.2026", "18.03.2026"],
          ["02.04.2026", "15.04.2026"],
          ["30.04.2026", "14.05.2026"],
          ["27.08.2026", "09.09.2026"],
          ["01.10.2026", "14.10.2026"],
          ["29.10.2026", "11.11.2026"],
          ["26.11.2026", "13.12.2026"],
        ],
      },
      {
        id: "grabner",
        name: "Brunnerberghof Grabner",
        address: "Wiener Neustädter Straße 27, 2542 Kottingbrunn, Austria",
        website: "https://www.brunnerberghof.at/",
        ranges: [
          ["15.01.2026", "21.01.2026"],
          ["05.02.2026", "11.02.2026"],
          ["12.03.2026", "18.03.2026"],
          ["23.04.2026", "29.04.2026"],
          ["21.05.2026", "27.05.2026"],
          ["10.09.2026", "16.09.2026"],
          ["22.10.2026", "28.10.2026"],
          ["19.11.2026", "25.11.2026"],
          ["10.12.2026", "16.12.2026"],
        ],
      },
      {
        id: "riegler-herber",
        name: "Weingut Riegler-Herber",
        address: "Traubenweg 4, 2542 Kottingbrunn, Austria",
        website: "https://www.riegler-herber.at/",
        ranges: [
          ["15.01.2026", "21.01.2026"],
          ["12.02.2026", "18.02.2026"],
          ["05.03.2026", "11.03.2026"],
          ["26.03.2026", "01.04.2026"],
          ["16.04.2026", "22.04.2026"],
          ["14.05.2026", "20.05.2026"],
          ["27.08.2026", "02.09.2026"],
          ["17.09.2026", "23.09.2026"],
          ["08.10.2026", "14.10.2026"],
          ["29.10.2026", "04.11.2026"],
          ["19.11.2026", "25.11.2026"],
        ],
      },
      {
        id: "routil",
        name: "Weinbau Routil",
        address: "Feldgasse 17, 2542 Kottingbrunn, Austria",
        website: "https://www.routil.net/",
        ranges: [
          ["22.01.2026", "28.01.2026"],
          ["26.02.2026", "04.03.2026"],
          ["02.04.2026", "08.04.2026"],
          ["30.04.2026", "06.05.2026"],
          ["20.08.2026", "26.08.2026"],
          ["24.09.2026", "30.09.2026"],
          ["15.10.2026", "21.10.2026"],
          ["12.11.2026", "18.11.2026"],
        ],
      },
      {
        id: "rathbauer",
        name: "Wein & Gut Rathbauer",
        address: "Maria-Theresien-Straße 50, 2542 Kottingbrunn, Austria",
        website: "https://weingut-rathbauer.at/",
        ranges: [
          // Listed as single days in the calendar; stored as one inclusive range:
          ["21.08.2026", "23.08.2026"],
        ],
      },
    ];

    // ---- Helpers ----
    function parseDDMMYYYY(s) {
      const [dd, mm, yyyy] = s.split(".").map(Number);
      return new Date(Date.UTC(yyyy, mm - 1, dd, 0, 0, 0));
    }

    function parseInputDateToUTC(dateStr) {
      // dateStr = YYYY-MM-DD from <input type="date">
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d, 0, 0, 0));
    }

    function isOpenOnDate(heuriger, dateUTC) {
      return heuriger.ranges.some(([start, end]) => {
        const s = parseDDMMYYYY(start);
        const e = parseDDMMYYYY(end);
        return dateUTC >= s && dateUTC <= e;
      });
    }

    function fmtRanges(ranges) {
      // compact display: "13.01.2026–14.01.2026, 29.01.2026–15.02.2026, …"
      return ranges.map(([a,b]) => (a === b ? a : `${a}–${b}`)).join(", ");
    }

    // ---- Nominatim Geocoding w/ localStorage cache ----
    const GEO_CACHE_KEY = "heurigen_geo_cache_v1";

    function loadGeoCache() {
      try { return JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveGeoCache(cache) {
      localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(cache));
    }

    async function geocodeAddress(address) {
      const cache = loadGeoCache();
      if (cache[address]) return cache[address];

      // Nominatim usage policy: keep requests light; we only have a few addresses.
      const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(address);
      const res = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!res.ok) throw new Error("Geocode failed: " + res.status);
      const data = await res.json();
      if (!data || !data[0]) throw new Error("No geocode result for: " + address);

      const point = { lat: Number(data[0].lat), lon: Number(data[0].lon) };
      cache[address] = point;
      saveGeoCache(cache);
      return point;
    }

    // ---- Map & UI ----
    let map, markerLayer;
    const markersById = new Map();

    function makeDotIcon(color) {
      return L.divIcon({
        className: "",
        iconSize: [16, 16],
        iconAnchor: [8, 8],
        html: `<div style="
          width:16px;height:16px;border-radius:50%;
          background:${color};
          border:2px solid rgba(255,255,255,.9);
          box-shadow:0 1px 6px rgba(0,0,0,.35);
        "></div>`
      });
    }

    const ICON_GREEN = makeDotIcon("#198754");
    const ICON_RED   = makeDotIcon("#dc3545");

    function setMarkerStatus(id, open) {
      const marker = markersById.get(id);
      if (!marker) return;
      marker.setIcon(open ? ICON_GREEN : ICON_RED);
    }

    function renderList(dateUTC) {
      const list = document.getElementById("list");
      list.innerHTML = "";

      let openN = 0;

      HEURIGER.forEach(h => {
        const open = isOpenOnDate(h, dateUTC);
        if (open) openN++;

        const a = document.createElement("a");
        a.href = "#";
        a.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-start";
        a.innerHTML = `
          <div class="me-2">
            <div class="fw-semibold">
              <span class="status-dot" style="background:${open ? "#198754" : "#dc3545"};"></span>
              ${h.name}
            </div>
            <div class="small-muted">${h.address}</div>
            <div class="small mono mt-1">${fmtRanges(h.ranges)}</div>
          </div>
          <div class="text-end">
            <span class="badge rounded-pill ${open ? "text-bg-success" : "text-bg-danger"}">${open ? "OFFEN" : "ZU"}</span>
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-primary" href="${h.website}" target="_blank" rel="noopener">Website</a>
            </div>
          </div>
        `;

        a.addEventListener("click", (ev) => {
          ev.preventDefault();
          const marker = markersById.get(h.id);
          if (marker) {
            map.setView(marker.getLatLng(), 16, { animate: true });
            marker.openPopup();
          }
        });

        list.appendChild(a);

        // Keep marker status synced
        setMarkerStatus(h.id, open);
      });

      document.getElementById("openCount").textContent = `${openN} offen / ${HEURIGER.length} gesamt`;
    }

    function updateForSelectedDate() {
      const dateStr = document.getElementById("dateInput").value;
      if (!dateStr) return;
      const dateUTC = parseInputDateToUTC(dateStr);
      renderList(dateUTC);
    }

    async function init() {
      // Default date = today in Europe/Vienna-ish (safe format for <input type="date">)
      const today = new Date();
      const todayStr = today.toLocaleDateString("en-CA"); // YYYY-MM-DD
      const dateInput = document.getElementById("dateInput");
      dateInput.value = todayStr;

      document.getElementById("todayBtn").addEventListener("click", () => {
        dateInput.value = (new Date()).toLocaleDateString("en-CA");
        updateForSelectedDate();
      });

      dateInput.addEventListener("change", updateForSelectedDate);

      // Map centered on Kottingbrunn (approx.)
      map = L.map("map", { scrollWheelZoom: true }).setView([47.9518, 16.2295], 14);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);

      // Add markers (geocode addresses)
      const bounds = [];
      for (const h of HEURIGER) {
        let point;
        try {
          point = await geocodeAddress(h.address);
        } catch (e) {
          // Fallback: keep it near Kottingbrunn center if geocoding fails
          point = { lat: 47.9518, lon: 16.2295 };
          console.warn(e);
        }

        const marker = L.marker([point.lat, point.lon], { icon: ICON_RED });
        marker.bindPopup(`
          <div class="fw-semibold">${h.name}</div>
          <div class="small-muted">${h.address}</div>
          <div class="small mono mt-1">${fmtRanges(h.ranges)}</div>
          <div class="mt-2">
            <a class="btn btn-sm btn-outline-primary" href="${h.website}" target="_blank" rel="noopener">Website</a>
          </div>
        `);

        marker.addTo(markerLayer);
        markersById.set(h.id, marker);
        bounds.push([point.lat, point.lon]);
      }

      if (bounds.length >= 2) map.fitBounds(bounds, { padding: [18, 18] });

      // Initial render
      updateForSelectedDate();
    }

    init();
  </script>
</body>
</html>