<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publications</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Tabulator (Bootstrap 5 theme) -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator_bootstrap5.min.css"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>

  <style>
    /* iframe-friendly: no huge margins, table fills viewport nicely */
    html, body { height: 100%; }
    body { background: #fff; }
    .app-shell { min-height: 100%; display: flex; flex-direction: column; }
    .table-wrap { flex: 1; min-height: 60vh; }
    #pub-table { width: 100%; }
    .muted-small { font-size: .9rem; color: #6c757d; }
    .tabulator { border-radius: .5rem; overflow: hidden; }
    .tabulator .tabulator-header { font-weight: 600; }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="border-bottom bg-light">
      <div class="container-fluid py-3">
        <div class="d-flex flex-wrap align-items-center gap-2 justify-content-between">
          <div>
            <h1 class="h4 mb-0">Publications</h1>
            <div class="muted-small">Loaded from <code>/resources/publications.bib</code></div>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2">
            <input id="q" class="form-control" style="max-width: 320px;" placeholder="Search title, author, venue, DOI…" />
            <select id="year" class="form-select" style="max-width: 160px;">
              <option value="">All years</option>
            </select>
            <a id="downloadBib" class="btn btn-outline-primary" href="/resources/publications.bib" download>
              Download BibTeX
            </a>
          </div>
        </div>
      </div>
    </header>

    <main class="container-fluid py-3 table-wrap">
      <div id="status" class="alert alert-info d-none" role="alert"></div>
      <div id="pub-table"></div>
    </main>

    <footer class="border-top bg-light">
      <div class="container-fluid py-2 d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="muted-small">
          Tips: click column headers to sort • type to filter • table is iframe-embeddable
        </div>
        <div class="muted-small">
          Powered by Tabulator + Citation.js
        </div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS (optional but useful for alerts etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    // Citation.js (ESM) + BibTeX plugin
    // Pin versions for stability. Citation.js releases/bundles are documented by the project.  [oai_citation:2‡citation.js.org](https://citation.js.org/api/0.3/tutorial-getting_started.html?utm_source=chatgpt.com)
    // plugin-bibtex is part of the citation-js npm org.  [oai_citation:3‡npm](https://www.npmjs.com/org/citation-js?utm_source=chatgpt.com)
    import { Cite } from "https://cdn.jsdelivr.net/npm/@citation-js/core@0.7.22/+esm";
    import "https://cdn.jsdelivr.net/npm/@citation-js/plugin-bibtex@0.7.18/+esm";

    const statusEl = document.getElementById("status");
    const qEl = document.getElementById("q");
    const yearEl = document.getElementById("year");

    function setStatus(msg, kind = "info") {
      statusEl.className = `alert alert-${kind}`;
      statusEl.textContent = msg;
      statusEl.classList.remove("d-none");
    }
    function clearStatus() {
      statusEl.classList.add("d-none");
      statusEl.textContent = "";
    }

    function safeText(x) {
      if (!x) return "";
      return String(x).replace(/\s+/g, " ").trim();
    }

    function formatAuthors(cslItem) {
      const authors = cslItem.author || [];
      if (!authors.length) return "";

      // CSL-JSON authors look like {given, family} or {literal}
      return authors.map(a => {
        if (a.literal) return safeText(a.literal);
        const given = safeText(a.given);
        const family = safeText(a.family);
        return [family, given].filter(Boolean).join(", ");
      }).join("; ");
    }

    function getYear(cslItem) {
      // CSL-JSON often has issued: { "date-parts": [[YYYY, MM, DD]] }
      const dp = cslItem?.issued?.["date-parts"]?.[0];
      if (dp && dp[0]) return String(dp[0]);
      // fallback: sometimes "published-print"/"published-online"
      const dp2 = cslItem?.["published-online"]?.["date-parts"]?.[0] || cslItem?.["published-print"]?.["date-parts"]?.[0];
      if (dp2 && dp2[0]) return String(dp2[0]);
      return "";
    }

    function getVenue(cslItem) {
      // journal container-title
      return safeText(cslItem["container-title"] || cslItem["publisher"] || "");
    }

    function getVolumeIssuePages(cslItem) {
      const vol = safeText(cslItem.volume);
      const iss = safeText(cslItem.issue);
      const page = safeText(cslItem.page);
      const bits = [];
      if (vol) bits.push(`Vol ${vol}`);
      if (iss) bits.push(`(${iss})`);
      if (page) bits.push(`pp. ${page}`);
      return bits.join(" ");
    }

    function doiUrl(doi) {
      doi = safeText(doi).replace(/^https?:\/\/doi\.org\//i, "");
      if (!doi) return "";
      return `https://doi.org/${doi}`;
    }

    function parseOrcidsFromAuthorString(authorStr) {
      // If your BibTeX has authors like: "Name (0000-0000-0000-0000)"
      // we surface ORCIDs if present (simple heuristic).
      const matches = [];
      const re = /\((\d{4}-\d{4}-\d{4}-\d{3}[\dX])\)/g;
      let m;
      while ((m = re.exec(authorStr)) !== null) matches.push(m[1]);
      return matches;
    }

    // Build Tabulator
    const table = new Tabulator("#pub-table", {
      layout: "fitColumns",
      responsiveLayout: "collapse",
      pagination: true,
      paginationSize: 10,
      paginationSizeSelector: [10, 20, 50, 100],
      placeholder: "No publications to display.",
      columns: [
        { title: "Year", field: "year", width: 90, sorter: "number", hozAlign: "left" },
        {
          title: "Title",
          field: "title",
          sorter: "string",
          formatter: (cell) => {
            const row = cell.getRow().getData();
            const title = safeText(row.title);
            const url = safeText(row.url);
            if (url) {
              const a = document.createElement("a");
              a.href = url;
              a.target = "_blank";
              a.rel = "noopener noreferrer";
              a.textContent = title || "(untitled)";
              return a;
            }
            return title || "(untitled)";
          },
          widthGrow: 3
        },
        { title: "Authors", field: "authors", sorter: "string", widthGrow: 2 },
        { title: "Venue", field: "venue", sorter: "string", widthGrow: 1.5 },
        {
          title: "Vol/Issue/Pages",
          field: "vip",
          sorter: "string",
          widthGrow: 1.2
        },
        {
          title: "DOI",
          field: "doi",
          sorter: "string",
          formatter: (cell) => {
            const doi = safeText(cell.getValue());
            if (!doi) return "";
            const url = doiUrl(doi);
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${doi}</a>`;
          },
          widthGrow: 1.2
        }
      ],
      initialSort: [
        { column: "year", dir: "desc" }
      ],
    });

    function applyFilters() {
      const q = safeText(qEl.value).toLowerCase();
      const y = safeText(yearEl.value);

      table.setFilter((data) => {
        if (y && data.year !== y) return false;
        if (!q) return true;

        const hay = [
          data.title,
          data.authors,
          data.venue,
          data.doi,
          data.vip
        ].map(s => safeText(s).toLowerCase()).join(" • ");

        return hay.includes(q);
      });
    }

    qEl.addEventListener("input", applyFilters);
    yearEl.addEventListener("change", applyFilters);

    async function loadBib() {
      setStatus("Loading publications…");

      let bibText = "";
      try {
        const res = await fetch("/resources/publications.bib", { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status} fetching /resources/publications.bib`);
        bibText = await res.text();
      } catch (err) {
        setStatus(
          "Could not load /resources/publications.bib. " +
          "Check the file path and that the site serves it (same-origin). " +
          `Details: ${err.message}`,
          "danger"
        );
        return;
      }

      let cite;
      try {
        cite = new Cite(bibText);
      } catch (err) {
        setStatus("BibTeX parsing failed. Please validate the .bib file. Details: " + err.message, "danger");
        return;
      }

      // Citation.js yields CSL-JSON items in cite.data
      const items = (cite.data || []).map((csl) => {
        const year = getYear(csl);
        const title = safeText(csl.title);
        const authors = formatAuthors(csl);
        const venue = getVenue(csl);
        const vip = getVolumeIssuePages(csl);
        const doi = safeText(csl.DOI || csl.doi || "");
        const url = safeText(csl.URL || doiUrl(doi));

        // Optional: surface ORCID presence if embedded in BibTeX author string.
        // (Citation.js may preserve that in author literals depending on BibTeX format.)
        const orcids = parseOrcidsFromAuthorString(authors);

        return {
          year,
          title,
          authors,
          venue,
          vip,
          doi,
          url,
          orcids
        };
      });

      // Populate year dropdown
      const years = Array.from(new Set(items.map(i => i.year).filter(Boolean)))
        .sort((a, b) => Number(b) - Number(a));
      for (const y of years) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearEl.appendChild(opt);
      }

      table.setData(items);
      clearStatus();
      applyFilters();
    }

    loadBib();
  </script>
</body>
</html>