<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Interval Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-dark text-light">

<div class="container py-5 text-center">
  <h1 class="mb-4">Interval Timer</h1>

  <div class="row justify-content-center mb-3">
    <div class="col-6 col-md-4">
      <label class="form-label" for="active-seconds">Active seconds</label>
      <input id="active-seconds" type="number" class="form-control" value="30" min="0">
    </div>
  </div>

  <div class="row justify-content-center mb-4">
    <div class="col-6 col-md-4">
      <label class="form-label" for="rest-seconds">Rest seconds</label>
      <input id="rest-seconds" type="number" class="form-control" value="10" min="0">
    </div>
  </div>

  <div class="my-4">
    <span id="phase" class="badge bg-info text-dark fs-6">Active</span>
    <h2 id="display" class="display-3 my-2">00:30</h2>
  </div>

  <div class="mb-3">
    <button id="start" class="btn btn-success me-2">Start</button>
    <button id="stop" class="btn btn-danger">Stop</button>
  </div>

  <div class="d-flex justify-content-center gap-4">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="repeatToggle">
      <label class="form-check-label" for="repeatToggle">
        Auto repeat
      </label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="wakeLockToggle">
      <label class="form-check-label" for="wakeLockToggle">
        Keep screen awake
      </label>
    </div>
  </div>
</div>

<script>
  const display = document.getElementById("display");
  const phaseEl = document.getElementById("phase");
  const repeatToggle = document.getElementById("repeatToggle");
  const wakeLockToggle = document.getElementById("wakeLockToggle");
  const startBtn = document.getElementById("start");
  const stopBtn = document.getElementById("stop");
  let timerId = null;
  let remaining = 0;
  let phase = "active";
  let wakeLock = null;
  let audioCtx = null;

  async function getAudioContext() {
    // Safari on iOS requires audio contexts to be created/resumed inside
    // a user gesture before they can play sound.
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") await audioCtx.resume();
    return audioCtx;
  }

  function totalSeconds(kind) {
    return +document.getElementById(`${kind}-seconds`).value || 0;
  }

  function setPhase(next) {
    phase = next;
    phaseEl.textContent = next === "active" ? "Active" : "Rest";
    phaseEl.className =
      "badge fs-6 " +
      (next === "active" ? "bg-info text-dark" : "bg-secondary");
  }

  function updateDisplay() {
    const m = Math.floor(remaining / 60);
    const s = remaining % 60;
    display.textContent =
      String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }

  async function playBeep() {
    // Use Web Audio to avoid data-URI decoding issues in some browsers.
    const ctx = await getAudioContext();
    const now = ctx.currentTime;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.2, now);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.3);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start(now);
    osc.stop(now + 0.35);
  }

  async function requestWakeLock(enabled) {
    if (!("wakeLock" in navigator)) return;

    if (enabled) {
      wakeLock = await navigator.wakeLock.request("screen");
    } else if (wakeLock) {
      await wakeLock.release();
      wakeLock = null;
    }
  }

  function startPhase(kind) {
    remaining = totalSeconds(kind);
    if (remaining <= 0) return false;

    setPhase(kind);
    updateDisplay();
    clearInterval(timerId);

    timerId = setInterval(() => {
      remaining--;
      updateDisplay();

      if (remaining <= 0) {
        clearInterval(timerId);
        playBeep();
        handleCompletion();
      }
    }, 1000);

    return true;
  }

  function handleCompletion() {
    if (phase === "active" && totalSeconds("rest") > 0) {
      if (startPhase("rest")) return;
    }

    if (repeatToggle.checked) {
      startPhase("active");
    }
  }

  startBtn.onclick = async () => {
    await getAudioContext();
    startPhase("active");
  };

  stopBtn.onclick = () => {
    clearInterval(timerId);
    timerId = null;
    setPhase("active");
    remaining = totalSeconds("active");
    updateDisplay();
  };

  wakeLockToggle.onchange = (e) => {
    requestWakeLock(e.target.checked);
  };
</script>

</body>
</html>
